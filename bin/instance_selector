#!/usr/bin/env ruby

require 'slop'
require 'instance_selector'

opts = Slop.parse do
  banner "Usage: ./instance_selector <options>"

  on 'e=', 'environment=', "The environment servers are tagged with"
  on 'r=', 'role=', "The role servers are tagged with"
  on 's=', 'spot-request-id=', "A spot request id"
  # on 't', 'tag-spots', "If the spot instances aren't tagged, update them"
  on 'v', 'verbose', "Print more info about the instances"
end

filters = {}
filters["tag:Role"] = opts[:r] if opts[:r]
filters["tag:Environment"] = opts[:e] if opts[:e]
filters["spot-instance-request-id"] = opts[:s] if opts[:s]

unless opts[:e] || opts[:r] || opts[:s]
  puts opts
  exit 1
end

client = InstanceSelector::Connection.factory(:aws)
instances = client.instances(filters)

instances.each do |k,v|
  print k
  if opts[:v]
    print "\t" if (k.size+1) % 8 < 1
    print "\t" + (v[:name] || "\t")
    print "\t" + v[:instance_id] if v[:instance_id]
  end
  print "\n"

  # TODO: Convert instances to an object to associate more data with it, and move tagging to method in providers
  # if opts[:t] && i[1].nil? && i[1] != ""
  #   tags = {}
  #   tags["Role"] = opts[:r] if opts[:r]
  #   tags["Environment"] = opts[:e] if opts[:e]
  #   tags["Name"] = "#{opts[:e]}-#{opts[:r]}"
  #   client.tag
  # end
end
